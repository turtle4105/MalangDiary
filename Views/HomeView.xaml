<Page x:Class="MalangDiary.Views.HomeView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:viewmodels="clr-namespace:MalangDiary.ViewModels;assembly=MalangDiary"
      xmlns:local="clr-namespace:MalangDiary.Helpers"
      d:DataContext="{d:DesignInstance Type=viewmodels:HomeViewModel}"
      mc:Ignorable="d"
      Background="#FFFEFD" Width="400" Height="800">

    <Grid Height="800">
        <Grid.RowDefinitions>
            <RowDefinition Height="50*" />
            <!-- 상단 타이틀 -->
            <RowDefinition Height="86*" />
            <!-- 자녀 목록 -->
            <RowDefinition Height="309*" />
            <!-- 일기 카드 -->
            <RowDefinition Height="126*" />
            <!-- 버튼 -->
            <RowDefinition Height="229*" />
            <!-- 하단 텍스트 -->
        </Grid.RowDefinitions>

        <!-- 상단 타이틀 -->
        <DockPanel Grid.Row="0"
                   Margin="0,0,0,1"
                   Background="#FFACAC">
            <TextBlock Text="말랑일기" 
                       FontSize="16"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Margin="175,0,0,0"
                       FontFamily="Noto Sans KR"
                       Foreground="#FFFFFF"/>
            <Grid Width="30" Height="30" Margin="0,0,20,0"
                  VerticalAlignment="Center"
                  HorizontalAlignment="Right">
                <!-- 배경 버튼 -->
                <Button Background="{Binding SelectedChildIconColor, Converter={StaticResource HtmlColorToBrushConverter}}"
                        BorderBrush="#FFFFFF"
                        BorderThickness="1">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" CornerRadius="20">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                </Button>

                <!-- 겹쳐진 아이콘 이미지 -->
                <Image Source="/Resources/Images/Icons/baby-head-with-a-small-heart-outline.png" 
                       Width="15" Height="15"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       RenderOptions.BitmapScalingMode="HighQuality"/>
            </Grid>
        </DockPanel>

        <StackPanel Grid.Row="1"
            Orientation="Horizontal"
            Margin="20,0,20,308"
            Grid.RowSpan="2">

            <!-- [1] Dynamic Children Button List -->
            <ItemsControl ItemsSource="{Binding Children}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Command="{Binding DataContext.SelectChildCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                            CommandParameter="{Binding}"
                            Width="56" Height="56"
                            Margin="4"
                            Background="Transparent"
                            BorderThickness="0">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid>
                                        <Ellipse Fill="{Binding IconColor, Converter={StaticResource HtmlColorToBrushConverter}}" 
                                             Stroke="{Binding IsSelected, Converter={StaticResource SelectedChildBorderConverter}}" 
                                             StrokeThickness="2"/>
                                        <Image Source="/Resources/Images/Icons/baby-head-with-a-small-heart-outline.png" 
                                           Width="30" Height="30"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           RenderOptions.BitmapScalingMode="HighQuality"/>
                                    </Grid>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>

                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- [2] Add Child (+) Button -->
            <Grid Width="56" Height="56" Margin="4">
                <Button Background="Transparent"
                    BorderThickness="0"
                    Command="{Binding GoToRgsChdCommand}">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Grid>
                                <Ellipse Stroke="LightGray" Fill="Transparent" />
                                <TextBlock Text="+" 
                                   FontSize="24" 
                                   HorizontalAlignment="Center" 
                                   Foreground="LightGray"
                                   VerticalAlignment="Center" Margin="0,0,0,5" />
                            </Grid>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </Grid>
        </StackPanel>

        
        <!-- Today's Diary Panel -->
        <Grid Grid.Row="2" Margin="20,10,20,20">
            <Grid.Resources>
                <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            </Grid.Resources>

            <!-- [1] Shadow Background Layer -->
            <Border Background="White"
                CornerRadius="20"
                Effect="{StaticResource ShadowEffect}" />

            <!-- [2] Content Layer -->
            <Border CornerRadius="20"
                ClipToBounds="True"
                Background="Transparent">

                <Grid>
                    <!-- [2-1] When NO Diary -->
                    <Border Background="#FFFFFF"
                        CornerRadius="20"
                        Padding="16"
                        BorderBrush="Transparent"
                        Visibility="{Binding HasDiary, Converter={StaticResource InverseBoolToVis}}">
                        <StackPanel>
                            <!-- Date and Weather -->
                            <DockPanel>
                                <TextBlock Text="{Binding DateText}"
                                   HorizontalAlignment="Left"
                                   FontFamily="Noto Sans KR"
                                   Foreground="#2A2A2A"/>
                                <TextBlock Text="{Binding WeatherText, StringFormat='날씨: {0}'}"
                                   HorizontalAlignment="Right"
                                   FontFamily="Noto Sans KR"
                                   Foreground="#2A2A2A"/>
                            </DockPanel>

                            <!-- No Diary Message -->
                            <StackPanel HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Margin="0,70,0,0">
                                <Image Source="/Resources/Images/Icons/pen.png"
                                    Width="30"
                                    Height="30"
                                    Margin="0,0,0,8"/>
                                <TextBlock Text="오늘 등록된 일기가 없어요."
                                       FontSize="13"
                                       Foreground="#2A2A2A"
                                       HorizontalAlignment="Center"
                                       FontFamily="Noto Sans KR"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- [2-2] When Diary EXISTS -->
                    <Border Background="#FFFFFF"
                        CornerRadius="20"
                        Padding="0"
                        BorderBrush="Transparent"
                        Visibility="{Binding HasDiary, Converter={StaticResource BoolToVis}}">

                        <Grid>
                            <!-- [A] Background Image with Rounded Corners -->
                            <Border CornerRadius="20" ClipToBounds="True">
                                <Border.Background>
                                    <ImageBrush ImageSource="{Binding DiaryImageSource}" Stretch="UniformToFill" />
                                </Border.Background>
                            </Border>

                            <!-- [B] Gradient Overlay -->
                            <Border CornerRadius="20" Background="Transparent">
                                <Rectangle VerticalAlignment="Bottom"
                                    Height="120"
                                    RadiusX="20"
                                    RadiusY="20">
                                    <Rectangle.Fill>
                                        <LinearGradientBrush StartPoint="0,1" EndPoint="0,0">
                                            <GradientStop Color="#CC000000" Offset="0.0"/>
                                            <GradientStop Color="Transparent" Offset="1.0"/>
                                        </LinearGradientBrush>
                                    </Rectangle.Fill>
                                </Rectangle>
                            </Border>

                            <!-- [C] Date and Weather -->
                            <Grid Margin="16" VerticalAlignment="Top">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding DateText}"
                                FontSize="18"
                                FontWeight="Bold"
                                Foreground="White"/>
                                <TextBlock Grid.Column="1"
                                Text="{Binding WeatherText, StringFormat='날씨: {0}'}"
                                FontSize="14"
                                Foreground="White"/>
                            </Grid>

                            <!-- [D] Title + Emotion Tags -->
                            <StackPanel VerticalAlignment="Bottom" Margin="16">
                                <TextBlock Text="오늘의 일기"
                                    FontFamily="Noto Sans KR"
                                    FontSize="18"
                                    FontWeight="Bold"
                                    Foreground="White"
                                    Margin="0,0,0,8"/>
                                <ItemsControl ItemsSource="{Binding EmotionTags}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Margin="4"
                                                Padding="8,3"
                                                Background="Transparent"
                                                BorderBrush="#FFFFFF"
                                                BorderThickness="1.5"
                                                CornerRadius="13">
                                                <TextBlock Text="{Binding}"
                                                    Foreground="White"
                                                    FontSize="13"
                                                    FontWeight="SemiBold"
                                                    FontFamily="Noto Sans KR"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>





        <!-- 버튼 -->
        <StackPanel Grid.Row="3" Margin="20,0,20,0" UseLayoutRounding="False" >
            <!-- 일기쓰기 버튼 -->
            <Button Content="일기쓰기"
                FontSize="14"
                FontFamily="Noto Sans KR"
                Height="52"
                Background="#FFACAC" 
                Foreground="White" 
                BorderThickness="0" 
                Command="{Binding GoToRcdDiaryCommand}"
                Margin="0,0,0,10">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="26">
                            <ContentPresenter HorizontalAlignment="Center" 
                                VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
            </Button>

            <!-- 일기확인 버튼 -->
            <Button Content="일기확인" 
                Height="52"
                FontFamily="Noto Sans KR"
                FontSize="14"
                Background="#FFF9F0" 
                Foreground="#FFACAC" 
                BorderBrush="#FFACAC" 
                BorderThickness="1.5" 
                Command="{Binding GoToChkCldCommand}" 
                Margin="0,0,0,10">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}" 
                            CornerRadius="26">
                            <ContentPresenter HorizontalAlignment="Center" 
                                              VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
            </Button>
        </StackPanel>

        <!-- 하단 텍스트 -->
        <TextBlock Grid.Row="4"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Text="Tip.말을 10분 넘게 하면 말랑 일기가 나오는 데 시간이 조금 더 걸릴 수 있어요."
                   FontSize="11"
                   Foreground="#FFACAC"
                   FontFamily="Noto Sans KR" Height="16" Width="266"/>
    </Grid>
</Page>
